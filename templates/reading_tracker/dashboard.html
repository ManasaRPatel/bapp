{% extends 'base.html' %}

{% block title %}Dashboard - Book Reading Habit Analyzer{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Reading Dashboard</h1>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <h3>Total Books</h3>
                <p class="h2 mb-0">{{ total_books }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3>Books Completed</h3>
                <p class="h2 mb-0">{{ books_completed }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3>Currently Reading</h3>
                <p class="h2 mb-0">{{ current_books.count }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <h3>Pages (30 days)</h3>
                <p class="h2 mb-0">{{ pages_last_30_days }}</p>
            </div>
        </div>
    </div>

    <!-- Reading Progress Chart -->
   <div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="card-title">Reading Progress</h2>
                    <div class="mb-3">
                        <select id="timeRange" class="form-select">
                            <option value="7" selected>Last 7 Days</option>
                            <option value="30" >Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                    <canvas id="readingProgressChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Book Status Distribution</h3>
                    <canvas id="bookStatusBarChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Status Overview</h3>
                    <canvas id="bookStatusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Reading Pace</h3>
                    <div class="text-center">
                        <h4 class="mt-3">Average Pages per Day</h4>
                        <h2 id="avgPagesPerDay">-</h2>
                        <h4 class="mt-3">Books Completed</h4>
                        <h2 id="booksCompleted">-</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Current Books and Goals -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Currently Reading</h5>
                    {% if current_books %}
                        <div class="list-group">
                            {% for book in current_books %}
                                <a href="{% url 'book_detail' book.pk %}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ book.title }}</h6>
                                        <small>{{ book.genre }}</small>
                                    </div>
                                    <p class="mb-1">by {{ book.author }}</p>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No books currently being read.</p>
                        <a href="{% url 'add_book' %}" class="btn btn-primary">Add a Book</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Active Goals</h5>
                    {% if active_goals %}
                        {% for goal in active_goals %}
                            <div class="goal-progress mb-3">
                                <h6>{{ goal.get_goal_type_display }} Goal</h6>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: {{ goal.progress }}%"
                                         aria-valuenow="{{ goal.progress }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <span class="percentage">{{ goal.progress|floatformat:1 }}%</span>
                                <p class="mb-0">
                                    Target: {{ goal.target_pages }} pages
                                    {% if goal.target_books %}
                                        and {{ goal.target_books }} books
                                    {% endif %}
                                </p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No active reading goals.</p>
                        <a href="{% url 'add_goal' %}" class="btn btn-primary">Set a Goal</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fetch and initialize reading progress chart
    fetch('{% url "reading_progress_data" %}')
        .then(response => response.json())
        .then(data => {
            initReadingProgressChart('reading-progress-chart', data);
        });

    // Fetch and initialize genre distribution chart
    fetch('{% url "genre_distribution_data" %}')
        .then(response => response.json())
        .then(data => {
            initGenreChart('genre-chart', data);
        });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let readingProgressChart = null;
    let bookStatusChart = null;
    let bookStatusBarChart = null;

    function updateCharts(days) {
        // Fetch reading progress data
        fetch(`/api/reading-progress/?days=${days}`)
            .then(response => response.json())
            .then(data => {
                if (readingProgressChart) {
                    readingProgressChart.destroy();
                }
                
                readingProgressChart = new Chart(
                    document.getElementById('readingProgressChart'),
                    {
                        type: 'line',
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: 'Books Read',
                                data: data.books_read,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Books Read Over Time'
                                }
                            }
                        }
                    }
                );

                // Update statistics
                document.getElementById('avgPagesPerDay').textContent = data.avg_pages_per_day;
                document.getElementById('booksCompleted').textContent = data.total_books_completed;
            });

        // Fetch book status data
        fetch('/api/book-status/')
            .then(response => response.json())
            .then(data => {
                if (bookStatusChart) {
                    bookStatusChart.destroy();
                }
                if (bookStatusBarChart) {
                    bookStatusBarChart.destroy();
                }
                
                // Bar Chart (now displayed first and more prominently)
                bookStatusBarChart = new Chart(
                    document.getElementById('bookStatusBarChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: ['Currently Reading', 'Completed', 'Abandoned', 'To Be Read'],
                            datasets: [{
                                label: 'Number of Books',
                                data: [
                                    data.currently_reading,
                                    data.completed,
                                    data.abandoned,
                                    data.to_be_read
                                ],
                                backgroundColor: [
                                    '#36a2eb',  // Blue for Currently Reading
                                    '#4bc0c0',  // Green for Completed
                                    '#ff6384',  // Red for Abandoned
                                    '#ffcd56'   // Yellow for To Be Read
                                ],
                                borderWidth: 1,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        font: {
                                            size: 12
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Number of Books',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.parsed.y} book${context.parsed.y !== 1 ? 's' : ''}`;
                                        }
                                    }
                                }
                            }
                        }
                    }
                );

                // Doughnut Chart (now as a secondary visualization)
                bookStatusChart = new Chart(
                    document.getElementById('bookStatusChart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: ['Currently Reading', 'Completed', 'Abandoned', 'To Be Read'],
                            datasets: [{
                                data: [
                                    data.currently_reading,
                                    data.completed,
                                    data.abandoned,
                                    data.to_be_read
                                ],
                                backgroundColor: [
                                    '#36a2eb',
                                    '#4bc0c0',
                                    '#ff6384',
                                    '#ffcd56'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    }
                );
            });
    }

    // Handle time range changes
    document.getElementById('timeRange').addEventListener('change', function(e) {
        updateCharts(e.target.value);
    });

    // Initial load with 30 days
    updateCharts(7);
});
</script>


{% endblock %}